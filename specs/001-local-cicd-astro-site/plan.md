# Implementation Plan: Local CI/CD for Astro Site

**Branch**: `001-local-cicd-astro-site` | **Date**: 2025-10-19 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-local-cicd-astro-site/spec.md`

**Note**: This plan was generated by the `/speckit.plan` command and includes comprehensive repository review findings.

## Summary

Implement a local-first CI/CD pipeline for an Astro.build static website deployed to GitHub Pages, with zero GitHub Actions usage for CI/CD processes (only deployment). The system provides a modular architecture with clear separation between website, TUI, and scripts modules, structured logging with JSON output, pre-commit secret validation, and automatic deployment rollback on failure. The implementation addresses 7 critical repository issues identified during planning review.

## Technical Context

**Language/Version**:
- Frontend: JavaScript/TypeScript (Astro 5.14.6, Node.js LTS)
- Scripts: Bash 4.0+ (local CI/CD, TUI)

**Primary Dependencies**:
- **Astro.build** 5.14.6 - Static site generator
- **Playwright** 1.56.1 - End-to-end testing
- **Mocha** 11.7.4 - Unit/integration testing framework
- **Prettier** 3.6.2 - Code formatting (auto-fix capability)
- **@testing-library/preact** 3.2.4 - Component testing
- NEEDS CLARIFICATION: Pre-commit hook framework (husky vs git hooks)
- NEEDS CLARIFICATION: JSON logging library for Bash (jq-based or custom)

**Storage**:
- Static files (Astro build output → `dist/`)
- Logs → `logs/ci-<timestamp>.json` (structured JSON logging)
- Deployment state → NEEDS CLARIFICATION (for rollback tracking)

**Testing**:
- Unit: Mocha (existing at `web/tests/` or `web/src/tests/` - NEEDS CLARIFICATION on correct location)
- Integration: Mocha (inter-module tests)
- E2E: Playwright (user workflows)
- Performance: Lighthouse CI (NFR-001, NFR-002 validation)

**Target Platform**:
- Development: Linux/macOS/WSL (local CI/CD execution)
- Production: GitHub Pages (static hosting, free tier)
- Deployment: GitHub Actions (deployment workflow only, no CI/CD)

**Project Type**: Web application (static site + modular scripts)

**Performance Goals**:
- Page load: < 1.5 seconds on 3G (NFR-001)
- Lighthouse score: > 90 Performance (NFR-002)
- CI/CD duration: < 5 minutes for typical changes (NFR-003)
- Setup time: < 10 minutes for new developer (SC-003)

**Constraints**:
- Zero GitHub Actions cost for CI/CD (deployment only)
- Modular-first: Changes to TUI/scripts MUST NOT affect website
- Security: Pre-commit hooks MUST block secrets before commit
- Observability: All logs MUST be machine-parseable JSON

**Scale/Scope**:
- Single-page or small multi-page static site
- 3 modules: website (`web/`), TUI (`scripts/tui/`), local-CI (`scripts/local-ci/`)
- ~10-20 test files across unit/integration/e2e
- Expected: 1-5 developers, small project scope

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Principle I: Modular-First Design ✅ PASS (with violations to remediate)

**Status**: CONDITIONAL PASS - Existing violations identified, remediation planned

| Requirement | Current State | Compliance |
|-------------|---------------|------------|
| Self-contained modules | Partial - `web/`, `scripts/tui/`, `scripts/local-ci/` exist | ⚠️  NEEDS FIX |
| Clear interfaces | Missing - no documented contracts | ❌ VIOLATION (#1) |
| No cross-module breakage | Untested - no integration tests verify | ❌ VIOLATION (#2) |
| NO unnecessary files | `web/web/` nested directory exists (redundant?) | ❌ VIOLATION (#3) |
| Structure reflects boundaries | Unclear - tests in 2 locations (`web/tests/`, `web/src/tests/`) | ❌ VIOLATION (#4) |

**Violations Requiring Remediation**:
1. Missing module contracts/interfaces documentation
2. No integration tests to verify module independence
3. Investigate and remove `web/web/` if unnecessary
4. Consolidate test directory structure (choose one location)

**Justification**: Violations are pre-existing technical debt, not new complexity. Remediation is part of this feature scope.

### Principle II: Local-First CI/CD ❌ FAIL (blocking issues)

**Status**: CRITICAL VIOLATIONS - Must fix before implementation complete

| Requirement | Current State | Compliance |
|-------------|---------------|------------|
| Single command execution | Exists (`scripts/local-ci/run.sh`) | ✅ PASS |
| Output identical to GH Actions | NO - local uses simple echo, GH Actions not defined | ❌ VIOLATION (#5) |
| Remote = deployment only | NO GitHub workflow exists yet | ❌ VIOLATION (#6) |
| 100% local checks | Partially - script exists but incomplete | ⚠️  NEEDS COMPLETION |

**Blocking Issues**:
5. Current `run.sh` uses simple echo, not structured logging (violates FR-010)
6. No GitHub Actions deployment workflow defined (violates FR-002, FR-011)

**Remediation Plan**: Rewrite CI script with structured logging + create deployment workflow in Phase 2

### Principle III: Structured Observability ❌ FAIL (critical)

**Status**: CRITICAL VIOLATION - No structured logging implemented

| Requirement | Current State | Compliance |
|-------------|---------------|------------|
| JSON logging format | NO - uses `echo "Running..."` | ❌ VIOLATION (#7) |
| Timestamps | NO | ❌ VIOLATION (#7) |
| Clear error messages | Minimal | ⚠️  NEEDS IMPROVEMENT |
| Immediate error surfacing | NO - no error detection | ❌ VIOLATION (#7) |

**Blocking Issue**:
7. `scripts/local-ci/run.sh` lacks all structured logging requirements (see CRITICAL_ISSUES.md #1)

**Remediation Plan**: Implement JSON logging with jq or custom Bash formatter in Phase 1 research

### Principle IV: Security by Default ❌ FAIL (security blocker)

**Status**: CRITICAL SECURITY VIOLATION - No pre-commit hook

| Requirement | Current State | Compliance |
|-------------|---------------|------------|
| `.env` files + `.gitignore` | `.gitignore` exists with patterns, but no `.env` files | ⚠️  PARTIAL |
| Pre-commit hooks block secrets | NO HOOK EXISTS | ❌ VIOLATION (#8) |
| Validation identifies files/lines | N/A - no validation | ❌ VIOLATION (#8) |
| NO secrets in repository | `.gitignore` patterns exist (good) | ✅ PASS |

**Critical Blocking Issue**:
8. No pre-commit hook implementation (violates FR-009, major security risk)

**Remediation Plan**: Create pre-commit hook in Phase 1 as highest priority security fix

### Principle V: Test Coverage Completeness ⚠️  PARTIAL

**Status**: Framework exists, coverage incomplete

| Requirement | Current State | Compliance |
|-------------|---------------|------------|
| Unit tests | Framework exists (Mocha), unclear if tests written | ⚠️  UNKNOWN |
| Integration tests | NOT IMPLEMENTED | ❌ VIOLATION (#9) |
| E2E tests | Framework exists (Playwright), unclear coverage | ⚠️  UNKNOWN |
| Tests pass before push | NO - CI script doesn't enforce | ❌ VIOLATION (#10) |

**Issues**:
9. No integration tests for module interactions
10. CI script doesn't halt on test failure (needs error handling)

**Remediation Plan**: Add integration tests + fix CI script error handling in Phase 2

---

### Overall Gate Status: ⚠️  CONDITIONAL PASS

**Decision**: PROCEED TO PHASE 0 with remediation plan

**Rationale**:
- Violations are pre-existing technical debt, not new architecture flaws
- This feature's PURPOSE is to remediate these violations
- All violations documented with remediation tasks
- No unjustified complexity additions planned

**Mandatory Phase 1 Re-Check**:
After research and design, verify:
- ✅ Logging solution chosen (Principle III)
- ✅ Pre-commit hook approach defined (Principle IV)
- ✅ Test directory structure decision made (Principle I)
- ✅ Module contracts documented (Principle I)

## Project Structure

### Documentation (this feature)

```
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```
002-mcp-manager/
├── .git/
├── .github/
│   └── workflows/
│       └── deploy.yml           # GitHub Pages deployment (Phase 2 task)
├── .gitignore                    # Updated with .env patterns
├── .husky/                       # OR .git/hooks/ (research decision)
│   └── pre-commit               # Secret validation hook (Phase 1 task)
├── scripts/
│   ├── local-ci/
│   │   ├── run.sh               # Rewritten with JSON logging (Phase 2 task)
│   │   ├── lib/
│   │   │   ├── logger.sh        # JSON logging utilities (Phase 1 design)
│   │   │   └── validator.sh     # Secret detection patterns (Phase 1 design)
│   │   └── README.md
│   ├── tui/
│   │   ├── run.sh               # Interactive menu (Phase 2 task)
│   │   └── README.md
│   └── mcp/
│       ├── mcp-profile          # Existing MCP manager (unchanged)
│       └── README.md
├── web/
│   ├── src/
│   │   ├── components/          # Astro components
│   │   ├── pages/               # Astro pages
│   │   └── layouts/             # Astro layouts (if needed)
│   ├── tests/                   # DECISION NEEDED: Consolidate with src/tests
│   │   ├── unit/                # Unit tests (*.test.js)
│   │   ├── integration/         # Integration tests (*.integration.test.js)
│   │   └── e2e/                 # Playwright E2E tests (*.spec.js)
│   ├── public/                  # Static assets
│   ├── dist/                    # Build output (gitignored)
│   ├── astro.config.mjs         # Astro configuration
│   ├── package.json
│   └── README.md
├── logs/                         # CI/CD execution logs (gitignored)
│   └── ci-YYYYMMDD-HHMMSS.json  # Timestamped structured logs
├── .env.example                  # Template (Phase 1 task)
├── .env.local                    # Local dev (gitignored, Phase 1 task)
├── .env.production               # Production (gitignored, Phase 1 task)
├── specs/                        # Feature specifications (.specify framework)
│   └── 001-local-cicd-astro-site/
│       ├── spec.md
│       ├── plan.md              # This file
│       ├── research.md          # Phase 0 output
│       ├── data-model.md        # Phase 1 output
│       ├── quickstart.md        # Phase 1 output
│       ├── contracts/           # Phase 1 output
│       │   ├── ci-script.contract.md
│       │   ├── tui.contract.md
│       │   └── deployment.contract.md
│       ├── tasks.md             # Phase 2 output (via /speckit.tasks)
│       └── CRITICAL_ISSUES.md   # Repository audit findings
├── AGENTS.md                     # AI instructions
├── CLAUDE.md -> AGENTS.md        # Symlink
├── README.md
└── LICENSE
```

**Structure Decision**:

**Chosen**: Modular web application with 3 independent modules

**Module Boundaries**:
1. **Website Module** (`web/`) - Astro.build static site
   - Self-contained with own package.json
   - Independent test suite
   - Build output → `web/dist/`

2. **Local CI Module** (`scripts/local-ci/`) - CI/CD automation
   - Bash-based scripts with JSON logging library
   - No dependencies on `web/` internals (calls via npm scripts)
   - Produces structured logs → `logs/`

3. **TUI Module** (`scripts/tui/`) - Interactive menu
   - Bash-based TUI (dialog, whiptail, or gum framework)
   - Orchestrates CI module + deployment
   - No direct `web/` dependencies

**Critical Directory Issues Identified**:
- ⚠️  `web/web/` nested directory - INVESTIGATE in Phase 0
- ⚠️  `web/tests/` vs `web/src/tests/` - CONSOLIDATE decision in Phase 0
- ❌ Missing `.env` files - CREATE in Phase 1
- ❌ Missing `.husky/` or pre-commit hooks - IMPLEMENT in Phase 1

## Complexity Tracking

*Constitution violations identified - all are pre-existing technical debt being remediated*

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| JSON logging library (Principle III) | Machine-parseable logs required for FR-010 (debugging/monitoring) | Simple `echo` insufficient - no timestamps, no structure, cannot parse programmatically |
| Pre-commit hook framework (Principle IV) | Security requirement FR-009 (block secrets) | Manual review insufficient - human error risk too high for credential exposure |
| Test directory reorganization (Principle I) | Current `web/tests/` AND `web/src/tests/` violates clear boundaries | Keeping both creates confusion about test location, violates FR-005 (no unnecessary files) |
| `.env` file creation (Principle IV) | Environment configuration required per Clarification #2 | Hardcoding config violates security principle, no separation of local/prod |
| GitHub Actions workflow (Principle II) | Deployment automation required per FR-002, FR-011 | Manual deployment violates automation principle, no rollback capability |

**Note**: These are NOT new complexity additions. They are remediations of existing violations discovered during repository audit. All changes align with constitution principles and reduce overall complexity by eliminating technical debt.

---

## Phase 1 Post-Design Constitution Re-Check

*Re-evaluation after research and design completion*

### Principle I: Modular-First Design ✅ IMPROVED

**Status**: Violations addressed in design phase

| Requirement | Post-Design State | Compliance |
|-------------|-------------------|------------|
| Module contracts documented | ✅ Created `contracts/ci-script.contract.md` | ✅ PASS |
| Test directory structure decided | ✅ Consolidate to `web/tests/` (research.md) | ✅ PASS |
| web/web/ removal planned | ✅ Removal decision documented (research.md) | ✅ PASS |
| Clear boundaries defined | ✅ Data flow diagram in data-model.md | ✅ PASS |

**Remediation Status**: All Principle I violations resolved in design

### Principle III: Structured Observability ✅ RESOLVED

**Status**: Logging solution chosen and documented

| Requirement | Post-Design State | Compliance |
|-------------|-------------------|------------|
| JSON logging approach | ✅ jq-based custom functions (research.md) | ✅ PASS |
| Log schema defined | ✅ Entity 1 in data-model.md | ✅ PASS |
| Timestamp format specified | ✅ ISO 8601 UTC with milliseconds | ✅ PASS |
| Implementation plan | ✅ `scripts/local-ci/lib/logger.sh` | ✅ PASS |

**Remediation Status**: Principle III fully addressed

### Principle IV: Security by Default ✅ RESOLVED

**Status**: Pre-commit hook approach defined

| Requirement | Post-Design State | Compliance |
|-------------|-------------------|------------|
| Hook framework chosen | ✅ Husky + lint-staged + Gitleaks (research.md) | ✅ PASS |
| Secret patterns defined | ✅ Entity 2 in data-model.md | ✅ PASS |
| Installation documented | ✅ quickstart.md Step 3 | ✅ PASS |
| Testing strategy defined | ✅ Pre-commit hook contract | ✅ PASS |

**Remediation Status**: Principle IV fully addressed

---

### Overall Post-Design Gate Status: ✅ PASS

**All mandatory Phase 1 re-checks completed**:
- ✅ Logging solution chosen (jq-based custom functions)
- ✅ Pre-commit hook approach defined (Husky + Gitleaks)
- ✅ Test directory structure decision made (consolidate to `web/tests/`)
- ✅ Module contracts documented (`contracts/ci-script.contract.md`)

**Constitution Compliance**: All critical violations resolved or have clear remediation plan for Phase 2 implementation.

**APPROVED TO PROCEED TO PHASE 2** (Task Generation via `/speckit.tasks`)

